---
import InputGroup from '@components/ui/InputGroup.astro';
import LinkWrapper from '@components/ui/LinkWrapper.astro';
import { LOCALE } from '@config/locale.ts';
import { getLocale, getLocaleInfo, getLocaleMessages } from '@i18n/index.ts';
import type { WithChildren } from '@type/utils.ts';
import { buildId } from '@utils/dom.ts';
import { entriesOf } from '@utils/object.ts';
import { getRelativeLocaleUrl } from 'astro:i18n';
import Button from './Button.astro';
import ExperimentalIcon from './ExperimentalIcon.astro';

/**
 * Props for the locale selector component.
 *
 * Explicitly disallows children as locale entries are generated from config.
 */
type Props = WithChildren<false>;

const type = 'radio' as const;
const currentLocaleId = getLocale(Astro);
const msg = getLocaleMessages(currentLocaleId).option.locale;
---

<InputGroup
	id={LOCALE.id}
	title={msg.title}
	role="radiogroup"
	aria-required="true"
>
	{
		entriesOf(LOCALE.map)
			.map(([id, config]) => ({
				id,
				config,
				info: getLocaleInfo(id, config.regionId),
			}))
			.sort((a, b) =>
				a.info.languageName.localeCompare(b.info.languageName, currentLocaleId),
			)
			.map(({ id, config, info }) => {
				const { wip, rtl } = config;
				const { flag, languageName, regionName } = info;

				return (
					<LinkWrapper
						to={getRelativeLocaleUrl(id)}
						id={buildId(LOCALE.id, id)}
					>
						<Button
							as="div"
							role={type}
							aria-checked={id === currentLocaleId}
							{type}
						>
							{flag}
							<bdo dir={rtl ? 'rtl' : 'ltr'}>{languageName}</bdo>
							{regionName && `(${regionName})`}
							{wip && <ExperimentalIcon />}
						</Button>
					</LinkWrapper>
				);
			})
	}
</InputGroup>

<script>
	import { LOCALE } from '@config/locale.ts';
	import { buildId, getDefinedElementById } from '@utils/dom.ts';
	import { keysOf } from '@utils/object.ts';

	const anchors = keysOf(LOCALE.map).map((id) =>
		getDefinedElementById<HTMLAnchorElement>(buildId(LOCALE.id, id)),
	);

	for (const anchor of anchors) {
		anchor.addEventListener('click', () => (anchor.href += location.search), {
			once: true,
		});
	}
</script>
