---
import InputGroup from '@components/ui/InputGroup.astro';
import LinkWrapper from '@components/ui/LinkWrapper.astro';
import { LOCALE } from '@config/locale.ts';
import { getLocale, getLocaleInfo, getLocaleMessages } from '@i18n/index.ts';
import { entriesOf } from '@utils/index.ts';
import { getRelativeLocaleUrl } from 'astro:i18n';
import type { WithChildren } from '../../types.ts';

/**
 * Props for the locale selector component.
 *
 * Explicitly disallows children as locale entries are generated from config.
 */
type Props = WithChildren<false>;

const currentLocaleId = getLocale(Astro);
const msg = getLocaleMessages(currentLocaleId).locales;
---

<InputGroup
	id={LOCALE.id}
	title={msg.title}
	role="radiogroup"
	aria-required="true"
>
	{
		entriesOf(LOCALE.map)
			.map(([id, config]) => ({
				id,
				config,
				info: getLocaleInfo(id, config.regionId),
			}))
			.sort((a, b) =>
				a.info.languageName.localeCompare(b.info.languageName, currentLocaleId),
			)
			.map(({ id, config, info }) => {
				const { wip, rtl } = config;
				const { flag, languageName, regionName } = info;

				return (
					<LinkWrapper
						to={getRelativeLocaleUrl(id)}
						role="radio"
						aria-checked={id === currentLocaleId}
						{id}
					>
						{flag}
						<bdo dir={rtl ? 'rtl' : 'ltr'}>{languageName}</bdo>
						{regionName && `(${regionName})`}
						{wip && ' ðŸš§'}
					</LinkWrapper>
				);
			})
	}
</InputGroup>

<style>
	a {
		display: flex;
		flex-direction: row;
		justify-content: center;
		align-items: center;
		gap: var(--p-xs);
		flex-basis: calc(50% - 2 * var(--p-sm));
		flex-grow: 1;
		padding: var(--p-sm);
		background-color: var(--bg-1);
		color: var(--fg);
		text-align: center;
		white-space: nowrap;
		cursor: pointer;

		&:active {
			opacity: 1;
		}

		&[aria-checked='true'] {
			font-weight: var(--f-bolder);
			background-color: var(--bg-3);
			box-shadow: var(--s-box-md);
			opacity: 1;
			box-shadow: var(--s-box-md);
			z-index: 1;

			&::before {
				content: 'âœ“ ';
				font-weight: var(--f-bolder);
			}
		}
	}
</style>

<script>
	import { LOCALE } from '@config/locale.ts';
	import { getDefinedElementById, keysOf } from '@utils/index.ts';

	const anchors = keysOf(LOCALE.map).map(
		getDefinedElementById<HTMLAnchorElement>,
	);

	for (const anchor of anchors) {
		anchor.addEventListener('click', () => (anchor.href += location.search), {
			once: true,
		});
	}
</script>
