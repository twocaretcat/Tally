---
import { doesLocaleSupportLinting } from '@actions/analysis/linting/utils.ts';
import HiddenInput from '@components/ui/HiddenInput.astro';
import Icon from '@components/ui/Icon.astro';
import InputGroup from '@components/ui/InputGroup.astro';
import { OPTION, type OptionId } from '@config/option.ts';
import { getLocale, getLocaleMessages } from '@i18n/index.ts';
import { GlobeX } from '@lucide/astro';
import type { WithChildren } from '@type/utils.ts';
import { buildId } from '@utils/dom.ts';
import { entriesOf } from '@utils/object.ts';
import Button from './Button.astro';

/**
 * Props for the options selector component.
 *
 * Explicitly disallows children as option entries are generated from config.
 */
type Props = WithChildren<false>;

const type = 'checkbox' as const;
const currentLocaleId = getLocale(Astro);
const localeSupportsLinting = doesLocaleSupportLinting(currentLocaleId);
const msg = getLocaleMessages(currentLocaleId).option;

/**
 * Computes UI attributes for an option toggle.
 *
 * Disables grammar checking when the current locale does not support linting.
 *
 * @param id - Option identifier.
 * @param defaultValue - Default checked state for the option.
 * @returns Attributes controlling title, checked state, and disabled state.
 */
function getConditionalOptionAttributes(id: OptionId, defaultValue: boolean) {
	if (id === 'enableLinting' && !localeSupportsLinting) {
		return {
			title: msg.lintingRegion.unsupportedWarning.tooltip,
			checked: false,
			disabled: true,
		};
	}

	return {
		title: undefined,
		checked: defaultValue,
		disabled: false,
	};
}
---

<InputGroup id={OPTION.id} title={msg.general.title} role="group">
	{
		entriesOf(OPTION.map).map(([id, { defaultValue }]) => {
			const { title, checked, disabled } = getConditionalOptionAttributes(
				id,
				defaultValue,
			);

			return (
				<Button as="label" {type} {title}>
					<HiddenInput
						slot="input"
						name={OPTION.id}
						id={buildId(OPTION.id, id)}
						{checked}
						{type}
					/>
					{msg.general.map[id].label}
					{disabled && <Icon icon={GlobeX} />}
				</Button>
			);
		})
	}
</InputGroup>

<script>
	import { doesLocaleSupportLinting } from '@actions/analysis/linting/utils.ts';
	import { OPTION } from '@config/option.ts';
	import { getLocale } from '@i18n/index.ts';
	import { $option } from '@stores/options.ts';
	import { buildId, getDefinedElementById } from '@utils/dom.ts';
	import { entriesOf } from '@utils/object.ts';

	const currentLocaleId = getLocale();
	const localeSupportsLinting = doesLocaleSupportLinting(currentLocaleId);

	for (const [id, store] of entriesOf($option)) {
		const disabled = id === 'enableLinting' && !localeSupportsLinting;
		const checkbox = getDefinedElementById<HTMLInputElement>(
			buildId(OPTION.id, id),
		);

		// Update checkboxes when the option changes
		store.subscribe((value) => {
			checkbox.checked = disabled ? false : value;
		});

		// Update option when a option radio input is changed
		checkbox.addEventListener('change', () => {
			store.set(checkbox.checked);
		});

		checkbox.disabled = disabled;
		checkbox.ariaBusy = String(false);
	}
</script>
