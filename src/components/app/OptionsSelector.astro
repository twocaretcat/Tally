---
import HiddenInput from '@components/ui/HiddenInput.astro';
import InputGroup from '@components/ui/InputGroup.astro';
import { OPTION } from '@config/option.ts';
import { getLocaleMessages } from '@i18n/index.ts';
import { entriesOf } from '@utils/index.ts';
import type { WithChildren } from '../../types.ts';
import Button from './Button.astro';

/**
 * Props for the options selector component.
 *
 * Explicitly disallows children as option entries are generated from config.
 */
type Props = WithChildren<false>;

const type = 'checkbox' as const;
const msg = getLocaleMessages(Astro).options;
---

<InputGroup id={OPTION.id} title={msg.title} role="group">
	{
		entriesOf(OPTION.map).map(([id, { defaultValue }]) => (
			<Button as="label" {type}>
				<HiddenInput
					slot="input"
					name={OPTION.id}
					checked={defaultValue}
					{id}
					{type}
				/>
				{msg.map[id].label}
			</Button>
		))
	}
</InputGroup>

<script>
	import { type OptionId } from '@config/option.ts';
	import {
		$enableDebugLogging,
		$rememberInputText,
		$warnOnLargeInputText,
	} from '@stores/index.ts';
	import { getDefinedElementById } from '@utils/index.ts';
	import type { WritableAtom } from 'nanostores';
	import { mapEntries } from 'radashi';

	/**
	 * Associates a store with its corresponding checkbox element.
	 *
	 * @property store - The nanostores atom for this option
	 * @property checkbox - The DOM checkbox input element
	 */
	type OptionEntry = {
		store: WritableAtom<boolean>;
		checkbox: HTMLInputElement;
	};

	type OptionMap = Record<OptionId, OptionEntry>;

	const idStoreMap = {
		['rememberInputText']: $rememberInputText,
		['warnOnLargeInputText']: $warnOnLargeInputText,
		['enableDebugLogging']: $enableDebugLogging,
	} as const satisfies { [id in OptionId]: WritableAtom<boolean> };

	const optionMap: OptionMap = mapEntries(idStoreMap, (optionId, store) => [
		optionId,
		{
			store,
			checkbox: getDefinedElementById<HTMLInputElement>(optionId),
		},
	]);

	for (const { store, checkbox } of Object.values(optionMap)) {
		// Update checkboxes when the option changes
		store.subscribe((value) => {
			checkbox.checked = value;
		});

		// Update theme when a theme radio input is changed
		checkbox.addEventListener('change', () => {
			store.set(checkbox.checked);
		});
	}
</script>
