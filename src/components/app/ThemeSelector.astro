---
import HiddenInput from '@components/ui/HiddenInput.astro';
import InputGroup from '@components/ui/InputGroup.astro';
import { THEME } from '@config/theme.ts';
import { getLocale, getLocaleMessages } from '@i18n/index.ts';
import { entriesOf } from '@utils/index.ts';
import type { WithChildren } from '../../types.ts';
import Button from './Button.astro';
import ExperimentalIcon from './ExperimentalIcon.astro';
import SponsorIcon from './SponsorIcon.astro';

/**
 * Props for the theme selector component.
 *
 * Explicitly disallows children as theme entries are generated from config.
 */
type Props = WithChildren<false>;

const type = 'radio' as const;
const msg = getLocaleMessages(getLocale(Astro)).option.theme;
---

<InputGroup
	id={THEME.id}
	title={msg.title}
	role="radiogroup"
	aria-required="true"
>
	{
		entriesOf(THEME.map).map(([id, { wip, sponsor }]) => (
			<Button as="label" data-theme={id} {type}>
				<HiddenInput
					slot="input"
					name={THEME.id}
					checked={id === THEME.defaultValue.id}
					{id}
					{type}
				/>
				{msg.map[id].label}
				{sponsor && <SponsorIcon />}
				{wip && <ExperimentalIcon />}
			</Button>
		))
	}
</InputGroup>

<style>
	label {
		background: linear-gradient(
			90deg,
			var(--bg-1) 0%,
			var(--bg-1) 49.9%,
			var(--bg-2) 50.1%,
			var(--bg-2) 100%
		);
	}
</style>

<script>
	import { THEME } from '@config/theme.ts';
	import { $theme } from '@stores/index.ts';
	import { entriesOf, getDefinedElementById } from '@utils/index.ts';
	import { mapEntries } from 'radashi';

	const themeRadioMap = mapEntries(THEME.map, (themeId) => [
		themeId,
		getDefinedElementById<HTMLInputElement>(themeId),
	]);

	// Update theme radio inputs when the theme changes
	$theme.subscribe((value) => {
		if (value in themeRadioMap) {
			themeRadioMap[value].checked = true;

			return;
		}

		const defaultId = THEME.defaultValue.id;

		themeRadioMap[defaultId].checked = true;

		$theme.set(defaultId);
	});

	// Update theme when a theme radio input is changed
	for (const [id, radio] of entriesOf(themeRadioMap)) {
		radio.addEventListener('change', () => $theme.set(id));
	}
</script>
