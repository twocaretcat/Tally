---
import Icon from '@components/ui/Icon.astro';
import IoGroup from '@components/ui/IoGroup.astro';
import { X } from '@lucide/astro';
import Button from '../Button.astro';
import LintCard from './LintCard/LintCard.astro';

const id = 'lintPopover' as const;
---

<div id="lintPopoverAnchor" aria-hidden="true"></div>
<aside {id} popover role="dialog">
	<LintCard id="lintPopoverCard">
		<IoGroup>
			<Button
				aria-label="Close"
				popovertarget={id}
				popovertargetaction="hide"
				title="Close"
			>
				<Icon icon={X} />
			</Button>
		</IoGroup>
	</LintCard>
</aside>

<style>
	#lintPopoverAnchor {
		position: absolute;
		anchor-name: --issue-anchor;
		transition-duration: var(--d-md);
		transition-property: top, left;
	}

	[popover] {
		position: absolute;
		position-area: block-end;
		position-anchor: --issue-anchor;
		position-try-fallbacks:
			block-end inline-start,
			block-end inline-end;
		margin: var(--p-sm);
		padding: 0;
		background-color: transparent;
		border: 0;
		opacity: 0;
		transition-duration: var(--d-md);
		transition-property: display, opacity;
		transition-behavior: allow-discrete;
	}

	[popover]:popover-open {
		opacity: 1;
	}

	@starting-style {
		[popover]:popover-open {
			opacity: 0;
		}
	}
</style>

<script>
	import { $lintPopover } from '@stores/index.ts';
	import { getDefinedElementById } from '@utils/index.ts';
	import { updateLintCardById } from './LintCard/lint-card.ts';

	const lintPopover = getDefinedElementById('lintPopover');
	const lintPopoverAnchor = getDefinedElementById('lintPopoverAnchor');

	$lintPopover.subscribe(({ x, y, lint }) => {
		if (!lint) {
			lintPopover.hidePopover();

			return;
		}

		updateLintCardById('lintPopoverCard', lint);

		lintPopoverAnchor.style.left = `${x}%`;
		lintPopoverAnchor.style.top = `${y}%`;

		lintPopover.showPopover();
	});
</script>
